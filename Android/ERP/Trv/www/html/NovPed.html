<script>
    function consultaOrcamento() {
        if (goNrOrca.value.toString().trim() == "") { return; }

        if (parseInt(goNrOrca.value) == 0) {
            myApp.hideIndicator();
            limpaCampos();
            return;
        }
        else if (parseInt(goNrOrca.value) >= 1) { }
        else {
            myApp.hideIndicator();
            limpaCampos();
            myApp.alert("NÚMERO DO ORÇAMENTO INVÁLIDO", "ERRO");

            return;
        }

        //if (parseInt(goNrOrca.value) < 1500000) {
        //    consultaOrcamentoOffline();
        //    return;
        //}

        myApp.showIndicator();

        $.ajax({
            url: pcWsHttp + "consultaOrcamento?lcIdEmpr=TRV&lcIdFili=1&lcPeNume=" + goNrOrca.value.toString().trim() + "&lcClVend=" + poCnCadt.ca_codi.toString().trim(),
            type: "GET",
            dataType: "jsonp",
            contentType: "application/json; charset=utf-8",

            success: function (lmCnOrca) {
                myApp.hideIndicator();

                try {
                    if (lmCnOrca.length > 0) {
                        goDvData.innerHTML = jsonDate(lmCnOrca[0].pe_data);
                        goNrClie.value = lmCnOrca[0].id_clie;
                        goNrClie.onblur();

                        document.getElementById("divCabe").style.display = "";

                        var lcPdMvpr = "", lcRdStyl = "";

                        lcPdMvpr = $("#divMvpr").html();

                        var lnQtSald = 0;

                        for (var x = 0; x < lmCnOrca.length; x++) {
                            if (lmCnOrca[x].qt_sald < 0) { lnQtSald = 0; }
                            else { lnQtSald = lmCnOrca[x].qt_sald; }

                            if (lmCnOrca[x].mp_qtde > lnQtSald) { lcRdStyl = "style='color: red;'"; }
                            else { lcRdStyl = ""; }

                            lcPdMvpr += "<div id='div" + lmCnOrca[x].dm_cfab.toString().trim() + "' class='row no-gutter pedimvpr'>";
                            lcPdMvpr += "<div " + lcRdStyl + " class='col-auto'>" + lmCnOrca[x].dm_cfab.toString().trim() + "</div>";
                            lcPdMvpr += "<div " + lcRdStyl + " class='col-auto'>" + lnQtSald.toString().trim() + "</div>";
                            lcPdMvpr += "<div " + lcRdStyl + " class='col-auto'>" + lmCnOrca[x].mp_qtde.toString().trim() + "</div>";
                            lcPdMvpr += "<div " + lcRdStyl + " class='col-auto'>" + brMoney(lmCnOrca[x].mp_prun.toString().trim()) + "</div>";
                            lcPdMvpr += "<div " + lcRdStyl + " class='col-auto'>" + brMoney(parseFloat(lmCnOrca[x].mp_qtde) * parseFloat(lmCnOrca[x].mp_prun)) + "</div>";
                            lcPdMvpr += "<div " + lcRdStyl + " class='col-auto'>" + brDecimal(lmCnOrca[x].mp_pdes) + "</div>";
                            lcPdMvpr += "<div class='col-auto'><a href='#' onclick='removeProdutoPedido(\"" + lmCnOrca[x].dm_cfab.toString().trim() + "\")' class='button button-fill color-red'>REMOVER</a></div>";
                            lcPdMvpr += "</div>";
                        }

                        $("#divMvpr").html(lcPdMvpr).show();

                        calculaTotal();

                        goTxCfab.focus();
                    }
                    else {
                        limpaCampos();
                        goNrOrca.focus();
                        myApp.alert("ORÇAMENTO NÃO ENCONTRADO", "ERRO");
                    }
                }
                catch (loWkErro) {
                    limpaCampos();
                    goNrOrca.focus();
                    myApp.alert("ORÇAMENTO NÃO ENCONTRADO", "ERRO");
                }
            },
            error: function () {
                limpaCampos();
                goNrOrca.focus();
                myApp.hideIndicator();
                myApp.alert("ERRO AO CCONSULTAR ORÇAMENTO", "ERRO");
            }
        });
    }

    function pesquisaUltimosPedidos(llUlProx) {
        myApp.showIndicator();

        if (gmUlPedi.length > 0) {
            myApp.hideIndicator();

            consultaUltimoProximoOrcamento(llUlProx);

            return;
        }

        $.ajax({
            url: pcWsHttp + "pesquisaUltimosPedidos?lcIdEmpr=TRV&lcIdVend=" + poCnCadt.ca_codi.toString().trim(),
            type: "GET",
            dataType: "jsonp",
            contentType: "application/json; charset=utf-8",

            success: function (lmWkRsql) {
                myApp.hideIndicator();

                try {
                    if (lmWkRsql.length > 0) {
                        gmUlPedi = lmWkRsql;
                        consultaUltimoProximoOrcamento(llUlProx);
                    }
                    else {
                        myApp.alert("NENHUM ORÇAMENTO ENCONTRADO", "ERRO");
                        limpaCampos();
                    }
                }
                catch (loWkErro) {
                    myApp.alert("NENHUM ORÇAMENTO ENCONTRADO", "ERRO");
                    limpaCampos();
                }
            },
            error: function () {
                myApp.hideIndicator();
                myApp.alert("NENHUM ORÇAMENTO ENCONTRADO", "ERRO");
                limpaCampos();
            }
        });
    }

    function consultaUltimoProximoOrcamento(llUlProx) {
        if (llUlProx == 1) {
            try {
                gnCtVolt++;
                goNrOrca.onfocus();
                goNrOrca.value = gmUlPedi[gnCtVolt].toString().trim();
                goNrOrca.onblur();
            }
            catch (loWkErro) {
                myApp.alert("ÚLTIMO PEDIDO DO VENDEDOR", "ERRO");
                gnCtVolt = -1;
                limpaCampos();
            }
        }
        else if (llUlProx == 2) {
            try {
                gnCtVolt--;
                goNrOrca.onfocus();
                goNrOrca.value = gmUlPedi[gnCtVolt].toString().trim();
                goNrOrca.onblur();
            }
            catch (loWkErro) {
                myApp.alert("ÚLTIMO PEDIDO DO VENDEDOR", "ERRO");
                gnCtVolt = -1;
                limpaCampos();
            }
        }
    }

    function pesquisaClientes() {
        goSlClie.disabled = true;

        $("#sltClie").html("<option value='0'>CARREGANDO CLIENTES...</option>").show();

        $.ajax({
            url: pcWsHttp + "pesquisaClientes?lcIdEmpr=TRV&lcIdVend=" + poCnCadt.ca_codi.toString().trim() + "&lcIdClie:IsNull=True&lcClNome:IsNull=True&lcClCnpj:IsNull=True&lcIdCida:IsNull=True&lcClFone:IsNull=True",
            type: "GET",
            dataType: "jsonp",
            contentType: "application/json; charset=utf-8",

            success: function (lmPqClie) {
                try {
                    if (lmPqClie.length > 0) {
                        goSlClie.disabled = false;
                        var lcPqClie = "<option value='0'>LISTA DE CLIENTES</option>";

                        for (var x = 0; x < lmPqClie.length; x++) { lcPqClie += "<option value='" + lmPqClie[x].id_clie + "'>" + lmPqClie[x].cl_nome + "</option>"; }

                        $("#sltClie").html(lcPqClie).show();
                    }
                    else {
                        $("#sltClie").html("<option value='0'>NENHUM CLIENTE ENCONTRADO</option>").show();
                    }
                }
                catch (loWkErro) {
                    $("#sltClie").html("<option value='0'>ERRO AO PESQUISAR CLIENTES</option>").show();
                }
            },
            error: function () {
                $("#sltClie").html("<option value='0'>ERRO AO PESQUISAR CLIENTES</option>").show();
            }
        });
    }

    function consultaInformacoesCliente() {
        goTxCfab.focus();

        if (goNrClie.value == 0) {
            limpaCamposCliente();
            return;
        }
        else if (goNrClie.value >= 1) { }
        else {
            limpaCamposCliente();
            myApp.alert("CÓDIGO DO CLIENTE INVÁLIDO", "ERRO");

            return;
        }

        try {
            goSlClie.value = goNrClie.value;

            if (goSlClie.options[goSlClie.selectedIndex].innerHTML == "") {
                limpaCamposCliente();
                myApp.alert("CLIENTE NÃO ENCONTRADO", "ALERTA");
            }
        }
        catch (loWkErro) {
            limpaCamposCliente();
            myApp.alert("CLIENTE NÃO ENCONTRADO", "ALERTA");
        }
    }

    function limpaCamposCliente() {
        goNrClie.value = "";
        goSlClie.value = 0;
    }

    function consultaProduto() {
        var lcTxCfab = goTxCfab.value.toString().trim().toUpperCase();

        if (lcTxCfab == "") { return; }

        myApp.showIndicator();

        $.ajax({
            url: pcWsHttp + "consultaProduto?lcIdEmpr=TRV&lcDmCfab=" + lcTxCfab,
            type: "GET",
            dataType: "jsonp",
            contentType: "application/json; charset=utf-8",

            success: function (lmCnProd) {
                myApp.hideIndicator();

                try {
                    if (lmCnProd.length > 0) {
                        goTxCfab.value = lcTxCfab;
                        goDvDeno.innerHTML = lmCnProd[0].dm_deno;

                        if (lmCnProd[0].qt_sald < 0) { goDvQtes.innerHTML = 0; }
                        else { goDvQtes.innerHTML = lmCnProd[0].qt_sald; }

                        if (lmCnProd[0].dm_pcus == 0) { gnDmPcus = lmCnProd[0].dm_pvar * 0.4; }
                        else { gnDmPcus = lmCnProd[0].dm_pcus; }

                        gnDmPatc = lmCnProd[0].dm_patc;
                        gnDmPdis = lmCnProd[0].dm_pdis;
                        goNrPrun.value = lmCnProd[0].dm_pvar.toString().trim();
                        gnDmPvar = lmCnProd[0].dm_pvar;
                        gnWkPrun = lmCnProd[0].dm_pvar;

                        goNrPdes.value = "";
                        gnDmPdes = lmCnProd[0].dm_pdes;

                        gnDmQemb = lmCnProd[0].dm_qemb;
                        gnDmQtpr = lmCnProd[0].dm_qtpr;
                        gnDmProm = lmCnProd[0].dm_prom;

                        mateSaldo(lmCnProd[0].id_dmat.toString().trim());

                        consultaValorUltimaVenda(lmCnProd[0].id_dmat.toString().trim())
                    }
                    else {
                        limpaCamposProduto();
                        myApp.alert("NENHUM PRODUTO ENCONTRADO", "ALERTA");
                    }
                }
                catch (loWkErro) {
                    limpaCamposProduto();
                    myApp.alert("NENHUM PRODUTO ENCONTRADO", "ALERTA");
                }
            },
            error: function () {
                myApp.hideIndicator();
                limpaCamposProduto();
                myApp.alert("NENHUM PRODUTO ENCONTRADO", "ALERTA");
            }
        });
    }

    function mateSaldo(lcPaDmat) {
        $.ajax({
            url: pcWsHttp + "mateSaldo?lcIdEmpr=TRV&lcPaData=" + goDvData.innerHTML + "&lcPaAlmx=" + 1 + "&lcPaDmat=" + lcPaDmat,
            type: "GET",
            dataType: "jsonp",
            contentType: "application/json; charset=utf-8",

            success: function (lnMpQtes) {
                try { consultaQuantidadeSeparada(lcPaDmat, lnMpQtes); }
                catch (loWkErro) { myApp.alert("ERRO AO CALCULAR SALDO EM ESTOQUE", "ERRO"); }
            },
            error: function () { myApp.alert("ERRO AO CALCULAR SALDO EM ESTOQUE", "ERRO"); }
        });
    }

    function consultaQuantidadeSeparada(lcIdDmat, lnMpQtes) {
        $.ajax({
            url: pcWsHttp + "consultaQuantidadeSeparada?lcIdEmpr=TRV&lcIdDmat=" + lcIdDmat,
            type: "GET",
            dataType: "jsonp",
            contentType: "application/json; charset=utf-8",

            success: function (lnMpQtde) {
                try { goDvQtes.innerHTML = (lnMpQtes - lnMpQtde).toString().trim(); }
                catch (loWkErro) { myApp.alert("ERRO AO CONSULTAR QUANTIDADE SEPARADA", "ERRO"); }
            },
            error: function () { myApp.alert("ERRO AO CONSULTAR QUANTIDADE SEPARADA", "ERRO"); }
        });
    }

    function verificaQuantidade() {
        var lnWkRest = 0;

        if (gnDmQemb > 1) {
            lnWkRest = goNrQtde.value % gnDmQemb;

            if (lnWkRest > 0) {
                if (lnWkRest > (gnDmQemb / 2)) {
                    goNrQtde.value = parseFloat(goNrQtde.value) + (gnDmQemb - lnWkRest);
                    myApp.alert("PRODUTO VENDIDO EM EMBALAGEM DE " + gnDmQemb.toString().trim() + " UNIDADES, FOI ADICIONADO " + (gnDmQemb - lnWkRest).toString().trim(), "ALERTA");
                }
                else {
                    goNrQtde.value = goNrQtde.value - lnWkRest;

                    if (goNrQtde.value == 0) {
                        goNrQtde.value = gnDmQemb;
                        myApp.alert("PRODUTO VENDIDO EM EMBALAGEM DE " + gnDmQemb.toString().trim() + " UNIDADES", "ALERTA");
                    }
                    else { myApp.alert("PRODUTO VENDIDO EM EMBALAGEM DE " + gnDmQemb.toString().trim() + " UNIDADES, FOI SUBTRAÍDO " + lnWkRest.toString().trim(), "ALERTA"); }
                }
            }
        }

        gnWkPrun = gnDmPvar;

        if (gnDmQtpr > 0) {
            if (parseFloat(goNrQtde.value) >= gnDmQtpr) { myApp.alert("PRODUTO EM PROMOÇÃO " + brMoney(gnDmProm.toString().trim()), "ALERTA"); }
            else { myApp.alert("PRODUTO EM PROMOÇÃO ACIMA DE " + gnDmQtpr.toString().trim() + " ITENS " + brMoney(gnDmProm.toString().trim()), "ALERTA"); }
        }

        if (gnDmQtpr > 0 && parseFloat(goNrQtde.value) >= gnDmQtpr) {
            gnWkPrun = gnDmProm;
            goNrPrun.value = gnDmProm.toString().trim();
        }
        else if (parseFloat(goNrPrun.value) < gnDmPvar) {
            goNrPrun.value = gnDmPvar.toString().trim();
        }
    }

    function verificaPreco() {
        if (parseFloat(goNrPrun.value) < gnWkPrun) {
            goNrPrun.value = gnWkPrun.toString().trim();

            myApp.alert("VALOR NÃO AUTORIZADO, INFERIOR AO VALOR DE TABELA", "ALERTA");
        }
    }

    //function calculaPrecoComDesconto() {
    //    lnWkPrun = gnDmPvar * ((100 - goNrPdes.value) / 100);

    //    if (lnWkPrun > 0 && lnWkPrun <= gnDmPvar) { goNrPrun.value = lnWkPrun.toFixed(2); }
    //    else { goNrPrun.value = ""; }
    //}

    //function calculaPercentualDesconto() {
    //    lnWkPdes = (1 - goNrPrun.value / gnDmPvar) * 100;

    //    if (lnWkPdes > 0 && lnWkPdes < 100) { goNrPdes.value = lnWkPdes.toFixed(2); }
    //    else { goNrPdes.value = ""; }
    //}

    function consultaValorUltimaVenda(lcIdDmat) {
        var lcIdClie = goNrClie.value.toString().trim();

        if (lcIdClie == "") { return; }

        $.ajax({
            url: pcWsHttp + "consultaValorUltimaVenda?lcIdEmpr=TRV&lcIdDmat=" + lcIdDmat + "&lcIdClie=" + lcIdClie,
            type: "GET",
            dataType: "jsonp",
            contentType: "application/json; charset=utf-8",

            success: function (lnMpPrun) {
                try {
                    if (lnMpPrun > 0) { goDvUvda.innerHTML = brMoney(lnMpPrun.toString().trim()); }
                    else { goDvUvda.innerHTML = ""; }
                }
                catch (loWkErro) { myApp.alert("ERRO AO CONSULTAR PREÇO DA ÚLTIMA VENDA", "ERRO"); }
            },
            error: function () { myApp.alert("ERRO AO CONSULTAR PREÇO DA ÚLTIMA VENDA", "ERRO"); }
        });
    }

    function limpaCamposProduto() {
        goTxCfab.value = "";
        goDvDeno.innerHTML = "";
        goNrQtde.value = "";
        goDvQtes.innerHTML = "";
        goNrPrun.value = "";
        goNrPdes.value = "";
        goDvUvda.innerHTML = "";

        gnDmPdes = 100;
        gnDmPvar = 0;
        gnDmQemb = 0;
        gnDmQtpr = 0;
        gnDmProm = 0;
        gnWkPrun = 0;
        gnDmPcus = 0;
        gnDmPatc = 0;
        gnDmPdis = 0;
    }

    function adicionaProdutoPedido() {
        if (parseInt(goNrClie.value) > 0) { }
        else {
            myApp.alert("CÓDIGO DO CLIENTE INVÁLIDO", "ERRO");

            return;
        }

        if (goTxCfab.value.toString().trim() == "") {
            myApp.alert("CÓDIGO DO FABRICANTE INVÁLIDO", "ERRO");

            return;
        }

        if (parseFloat(goNrQtde.value) > 0) { }
        else {
            myApp.alert("QUANTIDADE INVÁLIDA", "ERRO");

            return;
        }

        if (parseFloat(goNrPrun.value) > 0) { }
        else {
            myApp.alert("PREÇO INVÁLIDO", "ERRO");

            return;
        }

        if (parseFloat(goNrPdes.value) > gnDmPdes) {
            myApp.alert("DESCONTO ACIMA DO AUTORIZADO", "ALERTA");
            goNrPdes.value = "";

            return;
        }

        if (parseFloat(goNrPdes.value) > 0 && parseFloat(goNrQtde.value) > parseFloat(goDvQtes.innerHTML)) {
            goNrPdes.value = "";

            myApp.alert("PRODUTO COMPRA NA PRAÇA % DESCONTO ZERO", "ERRO");

            return;
        }

        if (document.getElementById("div" + goTxCfab.value.toString().trim())) {
            goTxCfab.focus();

            return;
        }

        if (goNrOrca.value.trim() == "") { inserePedido(); }
        else { insereProduto(); }

        document.getElementById("divCabe").style.display = "";

        var lcPdMvpr = "", lcRdStyl = "";

        if (parseFloat(goNrQtde.value) > parseFloat(goDvQtes.innerHTML)) { lcRdStyl = "style='color: red;'"; }

        lcPdMvpr = $("#divMvpr").html();

        lcPdMvpr += "<div id='div" + goTxCfab.value.toString().trim() + "' class='row no-gutter pedimvpr'>";
        lcPdMvpr += "<div " + lcRdStyl + " class='col-auto'>" + goTxCfab.value.toString().trim() + "</div>";
        lcPdMvpr += "<div " + lcRdStyl + " class='col-auto'>" + goDvQtes.innerHTML.trim() + "</div>";
        lcPdMvpr += "<div " + lcRdStyl + " class='col-auto'>" + goNrQtde.value.toString().trim() + "</div>";
        lcPdMvpr += "<div " + lcRdStyl + " class='col-auto'>" + brMoneyCasasDecimais(goNrPrun.value.toString().trim()) + "</div>";
        lcPdMvpr += "<div " + lcRdStyl + " class='col-auto'>" + brMoney(goNrQtde.value * goNrPrun.value) + "</div>";
        lcPdMvpr += "<div " + lcRdStyl + " class='col-auto'>" + brDecimal(goNrPdes.value) + "</div>";
        lcPdMvpr += "<div class='col-auto'><a href='#' onclick='removeProdutoPedido(\"" + goTxCfab.value.toString().trim() + "\")' class='button button-fill color-red'>REMOVER</a></div>";
        lcPdMvpr += "</div>";

        $("#divMvpr").html(lcPdMvpr).show();

        calculaTotal();
    }

    function removeProdutoPedido(lcDmCfab) {
        $("#div" + lcDmCfab).remove();

        if ($("#divMvpr > div").length <= 1) { document.getElementById("divCabe").style.display = "none"; }

        calculaTotal();

        if (goNrOrca.value.trim() != "") { deletaProduto(lcDmCfab); }
    }

    function calculaTotal() {
        var lnToPeca = 0, lnVlDesc = 0, lnClTota = 0, lnClPdes = 0, lnVlFret = 0, lnPeTota = 0;

        lnVlFret = parseFloat(goNrFret.value.replace("R$ ", "").split(".").join("").replace(",", "."));

        if (lnVlFret > 0) { }
        else { lnVlFret = 0; }

        $("#divMvpr > div").each(function () {
            if (this.id != "divCabe") {
                lnClTota = parseFloat($("#" + this.id + " > div")[4].innerHTML.replace("R$ ", "").split(".").join("").replace(",", "."));
                lnClPdes = parseFloat($("#" + this.id + " > div")[5].innerHTML.split(".").join("").replace(",", "."));

                lnToPeca += lnClTota;
                lnVlDesc += lnClTota * (lnClPdes / 100);
            }
        });

        lnPeTota = lnToPeca - lnVlDesc + lnVlFret;

        if (lnToPeca > 0) {
            goDvTpec.innerHTML = brMoney(lnToPeca);
            goDvVdes.innerHTML = brMoney(lnVlDesc);
            goDvTota.innerHTML = brMoney(lnPeTota);
        }
        else {
            goDvTpec.innerHTML = "";
            goDvVdes.innerHTML = "";

            if (lnVlFret > 0) { goDvTota.innerHTML = brMoney(lnVlFret); }
            else { goDvTota.innerHTML = ""; }
        }
    }

    function pesquisaTransportadoras() {
        goSlTran.disabled = true;

        $("#sltTran").html("<option value='0'>CARREGANDO TRANSPORTADORAS...</option>").show();

        $.ajax({
            url: pcWsHttp + "pesquisaTransportadoras?lcIdEmpr=TRV",
            type: "GET",
            dataType: "jsonp",
            contentType: "application/json; charset=utf-8",

            success: function (lmPqTran) {
                try {
                    if (lmPqTran.length > 0) {
                        var lcPqTran = "<option value='0'></option>";

                        for (var x = 0; x < lmPqTran.length; x++) { lcPqTran += "<option value='" + lmPqTran[x].id_tran + "/" + lmPqTran[x].tr_vfre + "'>" + lmPqTran[x].tr_nome + "</option>"; }

                        $("#sltTran").html(lcPqTran).show();

                        goSlTran.disabled = false;
                    }
                    else { $("#sltTran").html("<option value='0'>NENHUMA TRANSPORTADORA ENCONTRADA...</option>").show(); }
                }
                catch (loWkErro) { $("#sltTran").html("<option value='0'>ERRO AO PESQUISAR TRANSPORTADORAS...</option>").show(); }
            },
            error: function () { $("#sltTran").html("<option value='0'>ERRO AO PESQUISAR TRANSPORTADORAS...</option>").show(); }
        });
    }

    function consultaValorFrete() {
        var lmSlTran = goSlTran.value.split("/");

        if (parseFloat(lmSlTran[1]) > 0) { goNrFret.value = brMoney(lmSlTran[1]); }
        else { goNrFret.value = ""; }

        calculaTotal();
    }

    function geraOrdemSeparacao() {
        if (parseInt(goNrClie.value) > 0) { }
        else {
            myApp.alert("CÓDIGO DO CLIENTE INVÁLIDO", "ERRO");

            return;
        }

        if (goDvTota.innerHTML.trim() == "") {
            myApp.alert("PEDIDO SEM PRODUTOS", "ERRO");

            return;
        }

        var lnWkQtes = 0, lnWkQtde = 0, lnPeQtde = 0;
        var llFlRtrn = false;
        var lcDmCfab = "";

        $("#divMvpr > div").each(function () {
            if (this.id != "divCabe") {
                lnWkQtes = parseInt($("#" + this.id + " > div")[1].innerHTML);
                lnWkQtde = parseInt($("#" + this.id + " > div")[2].innerHTML);
                lcDmCfab = $("#" + this.id + " > div")[0].innerHTML;
                lnPeQtde += lnWkQtde;

                if (lnWkQtde > lnWkQtes && parseInt(goSlTpsa.value) != 4) {
                    myApp.alert("ITEM " + lcDmCfab + " COM ESTOQUE INSUFICIENTE, ESCOLHA COMPRA NA PRAÇA", "ERRO");

                    llFlRtrn = true;
                }

                if (lnWkQtde <= lnWkQtes && parseInt(goSlTpsa.value) == 4) {
                    myApp.alert("ITEM " + lcDmCfab + " COM ESTOQUE, NÃO PERMITIDO COMPRA NA PRAÇA", "ERRO");

                    llFlRtrn = true;
                }
            }
        });

        if (llFlRtrn) { return; }

        atualizaPedido(lnPeQtde);
        insereSeparacao();
    }

    function inserePedido() {
        myApp.showIndicator();
        var lcIdClie = goNrClie.value.toString().trim();

        $.ajax({
            url: pcWsHttp + "inserePedido?lcIdEmpr=TRV&lcIdClie=" + lcIdClie + "&lcIdFili=1&lcIdVend=" + poCnCadt.ca_codi.toString().trim(),
            type: "GET",
            dataType: "jsonp",
            contentType: "application/json; charset=utf-8",

            success: function (loInPedi) {
                myApp.hideIndicator();

                try {
                    goNrOrca.value = loInPedi.pe_nume.toString().trim();

                    insereProduto();
                }
                catch (loWkErro) { myApp.alert("ERRO AO INSERIR PEDIDO", "ERRO"); }
            },
            error: function () {
                myApp.hideIndicator();
                myApp.alert("ERRO AO INSERIR PEDIDO", "ERRO");
            }
        });
    }

    function insereProduto() {
        myApp.showIndicator();

        var lcMpPdes = "";

        if (goNrPdes.value.trim() == "") { lcMpPdes = "0"; }
        else { lcMpPdes = goNrPdes.value.trim(); }

        $.ajax({
            url: pcWsHttp + "insereProduto?lcIdEmpr=TRV&lcIdClie=" + goNrClie.value.toString().trim() + "&lcIdFili=1&lcPeNume=" + goNrOrca.value + "&lcDmCfab=" + goTxCfab.value + "&lcPeData=" + goDvData.innerHTML + "&lcMpQtde=" + goNrQtde.value + "&lcMpPrun=" + goNrPrun.value + "&lcMpPcus=" + gnDmPcus.toString().trim() + "&lcMpPvar=" + gnDmPvar.toString().trim() + "&lcMpPatc=" + gnDmPatc.toString().trim() + "&lcMpPdis=" + gnDmPdis.toString().trim() + "&lcMpPdes=" + lcMpPdes,
            type: "GET",
            dataType: "jsonp",
            contentType: "application/json; charset=utf-8",

            success: function (llInProd) {
                myApp.hideIndicator();

                try {
                    if (llInProd) { goTxCfab.focus(); }
                    else { myApp.alert("ERRO AO INSERIR PRODUTO", "ERRO"); }
                }
                catch (loWkErro) { myApp.alert("ERRO AO INSERIR PRODUTO", "ERRO"); }
            },
            error: function () {
                myApp.hideIndicator();
                myApp.alert("ERRO AO INSERIR PRODUTO", "ERRO");
            }
        });
    }

    function deletaProduto(lcDmCfab) {
        myApp.showIndicator();

        $.ajax({
            url: pcWsHttp + "deletaProduto?lcIdEmpr=TRV&lcIdFili=1&lcPeNume=" + goNrOrca.value + "&lcDmCfab=" + lcDmCfab + "&lcClVend=" + poCnCadt.ca_codi.toString().trim(),
            type: "GET",
            dataType: "jsonp",
            contentType: "application/json; charset=utf-8",

            success: function (llDlProd) {
                myApp.hideIndicator();

                try {
                    if (llDlProd) { }
                    else { myApp.alert("ERRO AO DELETAR PRODUTO", "ERRO"); }
                }
                catch (loWkErro) { myApp.alert("ERRO AO DELETAR PRODUTO", "ERRO"); }
            },
            error: function () {
                myApp.hideIndicator();
                myApp.alert("ERRO AO DELETAR PRODUTO", "ERRO");
            }
        });
    }

    function atualizaPedido(lnPeQtde) {
        myApp.showIndicator();
        var lcIdClie = goNrClie.value.toString().trim();
        var lcPePdes = ((parseFloat(goDvVdes.innerHTML.replace("R$ ", "").split(".").join("").replace(",", ".")) / parseFloat(goDvTpec.innerHTML.replace("R$ ", "").split(".").join("").replace(",", "."))) * 100).toFixed(2).toString();
        var lcPeTota = goDvTota.innerHTML.replace("R$ ", "").split(".").join("");
        var lcPeFret = goNrFret.value.replace("R$ ", "").split(".").join("");
        var lmSlTran = goSlTran.value.split("/");

        $.ajax({
            url: pcWsHttp + "atualizaPedido?lcIdEmpr=TRV&lcIdClie=" + lcIdClie + "&lcIdTran=" + lmSlTran[0].toString().trim() + "&lcPeQtde=" + lnPeQtde.toString().trim() + "&lcPeTota=" + lcPeTota + "&lcPeFret=" + lcPeFret + "&lcPeOrse=" + goSlTpsa.value.toString().trim() + "&lcPePdes=" + lcPePdes + "&lcPePdcp=" + goTxPdcp.value.toString().trim() + "&lcPeObse=" + goTaObse.value.toString().trim() + "&lcPeNume=" + goNrOrca.value,
            type: "GET",
            dataType: "jsonp",
            contentType: "application/json; charset=utf-8",

            success: function (llNvPedi) {
                myApp.hideIndicator();

                if (llNvPedi) {
                    limpaCampos();

                    myApp.alert("ORDEM DE SEPARAÇÃO GERADA COM SUCESSO", "SUCESSO");
                }
                else { myApp.alert("ERRO AO GERAR ORDEM DE SEPARAÇÃO", "ERRO"); }
            },
            error: function () { myApp.alert("ERRO AO GERAR ORDEM DE SEPARAÇÃO", "ERRO"); }
        });
    }

    function insereSeparacao() {
        myApp.showIndicator();

        $.ajax({
            url: pcWsHttp + "insereSeparacao?lcIdEmpr=TRV&lcIdFili=1&lcPeNume=" + goNrOrca.value + "&lcIdVend=" + poCnCadt.ca_codi.toString().trim(),
            type: "GET",
            dataType: "jsonp",
            contentType: "application/json; charset=utf-8",

            success: function (llInSepa) {
                myApp.hideIndicator();

                try {
                    if (llInSepa) { }
                    else { myApp.alert("ERRO AO GERAR ORDEM DE SEPARAÇÃO", "ERRO"); }
                }
                catch (loWkErro) { myApp.alert("ERRO AO GERAR ORDEM DE SEPARAÇÃO", "ERRO"); }
            },
            error: function () {
                myApp.hideIndicator();
                myApp.alert("ERRO AO GERAR ORDEM DE SEPARAÇÃO", "ERRO");
            }
        });
    }

    function limpaCampos() {
        ldDtHoje = new Date();

        goDvData.innerHTML = objetoDataParaStringData(ldDtHoje);

        goNrOrca.value = "";

        limpaCamposCliente();
        limpaCamposProduto();

        goSlTpsa.value = 1;
        goSlTran.value = 0;
        goNrFret.value = "";
        goTxPdcp.value = "";
        goTaObse.value = "";

        //gnCtVolt = -1;

        //gmUlPedi = [];

        $("#divMvpr > div").each(function () {
            if (this.id != "divCabe") { removeProdutoPedido($("#" + this.id + " > div")[0].innerHTML.trim()); }
        });
    }

    //@ sourceURL=NovPed1.js
</script>
<div class="content-block">
    <div class="buttons-row">
        <a href="#NovPed" class="tab-link active button">NOVO PEDIDO</a>
        <a href="#ConPec" class="tab-link button">CONSULTA PEÇA</a>
    </div>
</div>
<div class="tabs">
    <div id="NovPed" class="tab active">
        <div class="list-block">
            <ul>
                <li class="item-content">
                    <div class="item-inner">
                        <div class="item-title">DATA PEDIDO</div>
                        <div id="divData" class="item-after"></div>
                    </div>
                </li>
                <li>
                    <div class="item-content">
                        <div class="item-inner">
                            <div class="item-title label">ORÇAMENTO</div>
                            <div class="item-input">
                                <input id="numOrca" type="number" min="1" step="1" placeholder="DIGITE O NÚMERO DO ORÇAMENTO" onfocus="limpaCampos();" onblur="consultaOrcamento();">
                            </div>
                        </div>
                    </div>
                </li>
                <li>
                    <p class="buttons-row">
                        <a href="#" onclick="pesquisaUltimosPedidos(1)" class="button button-raised">ÚLT. ORÇA.</a>
                        <a href="#" onclick="pesquisaUltimosPedidos(2)" class="button button-raised">PRÓX. ORÇA.</a>
                    </p>
                </li>
                <li class="item-divider">CLIENTE</li>
                <li>
                    <div class="item-content">
                        <div class="item-inner">
                            <div class="item-title label" style="color: red;">CÓD. CLIENTE</div>
                            <div class="item-input">
                                <input id="numClie" type="number" min="1" step="1" placeholder="DIGITE O CÓDIGO DO CLIENTE" onblur="consultaInformacoesCliente();" onfocus="limpaCampos();">
                            </div>
                        </div>
                    </div>
                </li>
                <li>
                    <div class="item-content">
                        <div class="item-inner">
                            <div class="item-input">
                                <select id="sltClie" disabled="disabled" style="" onchange="if (this.value >= 1) { goNrClie.value = this.value; } else { limpaCamposCliente(); }"></select>
                            </div>
                        </div>
                    </div>
                </li>
                <li class="item-divider">PRODUTO</li>
                <li>
                    <div class="item-content">
                        <div class="item-inner">
                            <div class="item-title label" style="color: red;">CÓD. FABR.</div>
                            <div class="item-input">
                                <input id="txtCfab" type="text" placeholder="DIGITE O CÓDIGO DO FABRICANTE" onblur="consultaProduto();" onfocus="limpaCamposProduto();" />
                            </div>
                        </div>
                    </div>
                </li>
                <li class="item-content">
                    <div class="item-inner">
                        <div id="divDeno" class="item-after" style="margin-left: auto;"></div>
                    </div>
                </li>
                <li>
                    <div class="item-content">
                        <div class="item-inner">
                            <div class="item-title label" style="color: red;">QTDE</div>
                            <div class="item-input">
                                <input id="numQtde" type="number" min="0.01" placeholder="DIGITE O QUANTIDADE DO PRODUTO( EX: 9999,99 )" onblur="verificaQuantidade();">
                            </div>
                        </div>
                    </div>
                </li>
                <li class="item-content">
                    <div class="item-inner">
                        <div class="item-title">ESTOQUE</div>
                        <div id="divQtes" class="item-after"></div>
                    </div>
                </li>
                <li>
                    <div class="item-content">
                        <div class="item-inner">
                            <div class="item-title label" style="color: red;">PR. UNIT.</div>
                            <div class="item-input">
                                <input id="numPrun" type="number" min="0.01" placeholder="DIGITE O PREÇO DO PRODUTO( EX: 9999,99 )" onblur="verificaPreco();"> <!--onkeyup="calculaPercentualDesconto();"-->
                            </div>
                        </div>
                    </div>
                </li>
                <li>
                    <div class="item-content">
                        <div class="item-inner">
                            <div class="item-title label">% DESC.</div>
                            <div class="item-input">
                                <input id="numPdes" type="number" min="0.01" max="99.99" placeholder="DIGITE A % DESCONTO DO PRODUTO( EX: 99,99 )"> <!--onkeyup="calculaPrecoComDesconto();"-->
                            </div>
                        </div>
                    </div>
                </li>
                <li class="item-content">
                    <div class="item-inner">
                        <div class="item-title">VLR ULT. VDA</div>
                        <div id="divUvda" class="item-after"></div>
                    </div>
                </li>
            </ul>
        </div>
        <a href="#" id="ahrAdic" onclick="adicionaProdutoPedido();" class="button button-fill button-raised">ADICIONAR PRODUTO</a>
        <div id="divMvpr" class="content-block">
            <div id="divCabe" style="display: none;" class="row no-gutter">
                <div class='col-auto'><b>CÓD. FABR.</b></div>
                <div class='col-auto'><b>ESTOQUE</b></div>
                <div class='col-auto'><b>QTDE</b></div>
                <div class='col-auto'><b>PR. UNIT.</b></div>
                <div class='col-auto'><b>TOTAL</b></div>
                <div class='col-auto'><b>% DESC.</b></div>
                <div class='col-auto'></div>
            </div>
        </div>
        <div class="list-block">
            <ul>
                <li class="item-content">
                    <div class="item-inner">
                        <div class="item-title">TOTAL PEÇAS</div>
                        <div id="divTpec" class="item-after"></div>
                    </div>
                </li>
                <li class="item-content">
                    <div class="item-inner">
                        <div class="item-title">DESCONTO</div>
                        <div id="divVdes" class="item-after"></div>
                    </div>
                </li>
                <li class="item-divider">ORDEM DE SEPARAÇÃO</li>
                <li>
                    <div class="item-content">
                        <div class="item-inner">
                            <div class="item-input">
                                <select id="sltTpsa">
                                    <option value="1" selected="selected">BALCÃO FRENTE</option>
                                    <option value="2">ENTREGA</option>
                                    <option value="3">EXPEDIÇÃO</option>
                                    <option value="4">COMPRA NA PRAÇA</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </li>
                <li>
                    <div class="item-content">
                        <div class="item-inner">
                            <div class="item-title label">TRANSPORTADORA</div>
                            <div class="item-input">
                                <select id="sltTran" onchange="consultaValorFrete();" onblur="consultaValorFrete();"></select>
                            </div>
                        </div>
                    </div>
                </li>
                <li>
                    <div class="item-content">
                        <div class="item-inner">
                            <div class="item-title label">VLR FRETE</div>
                            <div class="item-input">
                                <input id="numFret" type="number" min="0.01" placeholder="DIGITE O VALOR DO FRETE( EX: 9999,99 )" onkeyup="calculaTotal();">
                            </div>
                        </div>
                    </div>
                </li>
                <li>
                    <div class="item-content">
                        <div class="item-inner">
                            <div class="item-title label">PED. COMPRA</div>
                            <div class="item-input">
                                <input id="txtPdcp" type="text" placeholder="DIGITE O PEDIDO DE COMPRA" />
                            </div>
                        </div>
                    </div>
                </li>
                <li class="align-top">
                    <div class="item-content">
                        <div class="item-inner">
                            <div class="item-title label">OBSERVAÇÃO</div>
                            <div class="item-input">
                                <textarea id="txaObse" placeholder="DIGITE A OBSERVAÇÃO DO PEDIDO"></textarea>
                            </div>
                        </div>
                    </div>
                </li>
                <li class="item-content">
                    <div class="item-inner">
                        <div class="item-title">TOTAL</div>
                        <div id="divTota" class="item-after"></div>
                    </div>
                </li>
            </ul>
        </div>
        <a href="#" id="ahrGera" onclick="geraOrdemSeparacao();" class="button button-fill button-raised">GERAR</a>
        <br />
        <br />
        <br />
    </div>
    <div id="ConPec" class="tab"></div>
</div>
<script>
    var goNrOrca = document.getElementById("numOrca");
    var goNrClie = document.getElementById("numClie");
    var goDvData = document.getElementById("divData");
    var goSlClie = document.getElementById("sltClie");
    var goDvDeno = document.getElementById("divDeno");
    var goNrQtde = document.getElementById("numQtde");
    var goDvQtes = document.getElementById("divQtes");
    var goNrPrun = document.getElementById("numPrun");
    var goNrPdes = document.getElementById("numPdes");
    var goDvUvda = document.getElementById("divUvda");
    var goTxCfab = document.getElementById("txtCfab");
    var goDvCabe = document.getElementById("divCabe");
    var goDvTpec = document.getElementById("divTpec");
    var goDvVdes = document.getElementById("divVdes");
    var goDvTota = document.getElementById("divTota");
    var goSlTran = document.getElementById("sltTran");
    var goNrFret = document.getElementById("numFret");
    var goSlTpsa = document.getElementById("sltTpsa");
    var goTxPdcp = document.getElementById("txtPdcp");
    var goTaObse = document.getElementById("txaObse");
    var ldDtHoje = new Date();
    var gnDmPdes = 100, gnDmPvar = 0, gnDmQemb = 0, gnDmQtpr = 0, gnDmProm = 0, gnWkPrun = 0, gnDmPcus = 0, gnDmPatc = 0, gnDmPdis = 0, gnCtVolt = -1;
    var gmUlPedi = [];

    $(document).ready(function () {
        goDvData.innerHTML = objetoDataParaStringData(ldDtHoje);

        OkTecladoAndroid2("numOrca", "ahrAdic");
        OkTecladoAndroid2("numClie", "sltClie");
        OkTecladoAndroid2("txtCfab", "numQtde");
        OkTecladoAndroid2("numQtde", "numPrun");
        OkTecladoAndroid2("numPrun", "numPdes");
        OkTecladoAndroid3("numPdes", "ahrAdic", "ahrAdic");
        OkTecladoAndroid2("numFret", "txtPdcp");
        OkTecladoAndroid2("txtPdcp", "txaObse");
        OkTecladoAndroid3("txaObse", "ahrGera", "ahrGera");

        $("#ConPec").load("ConPec.html");

        pesquisaClientes();
        pesquisaTransportadoras();
    });

    //@ sourceURL=NovPed2.js
</script>
